Love this combo â€” **Flask + MQTT** is perfect for IoT dashboards, real-time monitoring, device control panels, etc. Letâ€™s build it step-by-step in a **clean, production-style way**.

Weâ€™ll make a Flask API that:
âœ” Publishes messages to MQTT
âœ” Subscribes and receives messages from MQTT
âœ” Stores latest messages
âœ” Exposes REST APIs to interact with MQTT

---

## ğŸ§  1. Architecture Overview

```
Device/Sensor  â†’  MQTT Broker  â†’  Flask MQTT Client  â†’  REST API  â†’  Frontend
```

Flask will act as an **MQTT client** using the **paho-mqtt** library.

---

## ğŸ“¦ 2. Install Dependencies

```bash
pip install flask paho-mqtt python-dotenv
```

---

## ğŸ—‚ï¸ 3. Project Structure

```
flask_mqtt_app/
â”‚
â”œâ”€â”€ app.py
â”œâ”€â”€ mqtt_client.py
â”œâ”€â”€ config.py
â””â”€â”€ .env
```

---

## âš™ï¸ 4. Configuration

### `.env`

```
MQTT_BROKER=broker.hivemq.com
MQTT_PORT=1883
MQTT_TOPIC_SUB=demo/flask/sub
MQTT_TOPIC_PUB=demo/flask/pub
```

### `config.py`

```python
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    MQTT_BROKER = os.getenv("MQTT_BROKER")
    MQTT_PORT = int(os.getenv("MQTT_PORT", 1883))
    MQTT_TOPIC_SUB = os.getenv("MQTT_TOPIC_SUB")
    MQTT_TOPIC_PUB = os.getenv("MQTT_TOPIC_PUB")
```

---

## ğŸ“¡ 5. MQTT Client Module

### `mqtt_client.py`

```python
import paho.mqtt.client as mqtt
from config import Config
import json
from datetime import datetime

latest_messages = []  # In-memory store

def on_connect(client, userdata, flags, rc):
    print("Connected to MQTT Broker with result code", rc)
    client.subscribe(Config.MQTT_TOPIC_SUB)

def on_message(client, userdata, msg):
    payload = msg.payload.decode()
    message_data = {
        "topic": msg.topic,
        "message": payload,
        "timestamp": datetime.utcnow().isoformat()
    }
    print("Received:", message_data)
    latest_messages.append(message_data)

    # Keep only last 50 messages
    if len(latest_messages) > 50:
        latest_messages.pop(0)

def create_mqtt_client():
    client = mqtt.Client()
    client.on_connect = on_connect
    client.on_message = on_message
    client.connect(Config.MQTT_BROKER, Config.MQTT_PORT, 60)
    return client
```

---

## ğŸš€ 6. Flask Application

### `app.py`

```python
from flask import Flask, request, jsonify
from mqtt_client import create_mqtt_client, latest_messages
from config import Config
import threading
import json

app = Flask(__name__)

# Start MQTT client in background thread
mqtt_client = create_mqtt_client()
threading.Thread(target=mqtt_client.loop_forever, daemon=True).start()


# ------------------ ROUTES ------------------

@app.route("/")
def home():
    return {"message": "Flask MQTT API Running"}

# Publish message to MQTT
@app.route("/publish", methods=["POST"])
def publish_message():
    data = request.json
    message = data.get("message")

    if not message:
        return jsonify({"error": "Message is required"}), 400

    mqtt_client.publish(Config.MQTT_TOPIC_PUB, json.dumps(message))
    return jsonify({"status": "Message published", "message": message})

# Get latest received messages
@app.route("/messages", methods=["GET"])
def get_messages():
    return jsonify(latest_messages)

# Health check
@app.route("/health")
def health():
    return {"status": "OK"}

# ------------------ RUN ------------------

if __name__ == "__main__":
    app.run(debug=True, port=5000)
```

---

## â–¶ï¸ 7. Run the Application

```bash
python app.py
```

You should see:

```
Connected to MQTT Broker with result code 0
```

---

## ğŸ§ª 8. Testing the System

### ğŸ”¹ Publish a message via API

```bash
curl -X POST http://localhost:5000/publish \
     -H "Content-Type: application/json" \
     -d '{"message": {"temperature": 25}}'
```

### ğŸ”¹ View received messages

```bash
curl http://localhost:5000/messages
```

---

## ğŸ“² 9. Simulate an IoT Device (Optional)

Open another Python file:

```python
import paho.mqtt.publish as publish
import json
import time

while True:
    data = {"humidity": 60}
    publish.single("demo/flask/sub", json.dumps(data), hostname="broker.hivemq.com")
    time.sleep(5)
```

Now your Flask app will receive messages every 5 seconds ğŸ‰

---

## ğŸ›¡ï¸ 10. Production Improvements (Important)

| Feature                             | Why                |
| ----------------------------------- | ------------------ |
| Use a real broker (Mosquitto, EMQX) | Better reliability |
| Add authentication                  | Secure devices     |
| Store messages in DB                | Persistence        |
| Use QoS levels                      | Delivery guarantee |
| Add WebSocket (SocketIO)            | Real-time frontend |
| Dockerize                           | Easy deployment    |

---

## ğŸ§© MQTT QoS Example

```python
mqtt_client.publish("demo/flask/pub", "Hello", qos=1)
```

QoS Levels:

* `0` â†’ At most once
* `1` â†’ At least once
* `2` â†’ Exactly once

---

## ğŸ¯ What You Built

âœ” Flask REST API
âœ” MQTT Publisher
âœ” MQTT Subscriber
âœ” Real-time message handling
âœ” IoT-ready backend

---

If you want, next I can help you add:

* ğŸ“Š Live dashboard with React
* ğŸ—„ï¸ PostgreSQL storage
* ğŸ³ Docker setup
* ğŸ” Device authentication

Just tell me which direction you want to take this ğŸš€


Nice â€” letâ€™s turn this into a clear Proof of Concept (POC) that shows MQTT + Flask working end-to-end like a real IoT mini system.

This POC will demonstrate:

âœ… Device publishes sensor data
âœ… Flask subscribes to MQTT and receives it
âœ… Flask API publishes control messages
âœ… Device receives control messages

ğŸ§ª MQTT + Flask POC (End-to-End)ğŸ§  Flow of the POC[Device Simulator] â†’ MQTT Broker â†’ Flask App â†’ REST API â†‘ â†“ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Control Messages â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 

We will use the public HiveMQ broker so no local setup is required.

ğŸ“ Project Structuremqtt_flask_poc/ â”‚ â”œâ”€â”€ app.py # Flask API â”œâ”€â”€ mqtt_client.py # MQTT logic â”œâ”€â”€ device_simulator.py # Fake IoT device â”œâ”€â”€ config.py â””â”€â”€ requirements.txt ğŸ“¦ 1. Install Requirementsrequirements.txtflask paho-mqtt python-dotenv pip install -r requirements.txt âš™ï¸ 2. Configurationconfig.pyclass Config: MQTT_BROKER = "broker.hivemq.com" MQTT_PORT = 1883 # Device â†’ Server topic MQTT_TOPIC_SENSOR = "poc/device/sensor" # Server â†’ Device topic MQTT_TOPIC_CONTROL = "poc/device/control" ğŸ“¡ 3. MQTT Client for Flaskmqtt_client.pyimport paho.mqtt.client as mqtt from config import Config from datetime import datetime import json latest_sensor_data = [] mqtt_client_instance = None def on_connect(client, userdata, flags, rc): print("âœ… Connected to MQTT Broker:", rc) client.subscribe(Config.MQTT_TOPIC_SENSOR) def on_message(client, userdata, msg): payload = msg.payload.decode() data = { "topic": msg.topic, "payload": json.loads(payload), "timestamp": datetime.utcnow().isoformat() } print("ğŸ“© Sensor Data Received:", data) latest_sensor_data.append(data) if len(latest_sensor_data) > 20: latest_sensor_data.pop(0) def start_mqtt(): global mqtt_client_instance mqtt_client_instance = mqtt.Client() mqtt_client_instance.on_connect = on_connect mqtt_client_instance.on_message = on_message mqtt_client_instance.connect(Config.MQTT_BROKER, Config.MQTT_PORT, 60) mqtt_client_instance.loop_start() return mqtt_client_instance ğŸš€ 4. Flask APIapp.pyfrom flask import Flask, request, jsonify from mqtt_client import start_mqtt, latest_sensor_data, mqtt_client_instance from config import Config import json app = Flask(__name__) mqtt_client = start_mqtt() @app.route("/") def home(): return {"message": "MQTT Flask POC Running"} # ğŸ“¥ Get latest sensor readings @app.route("/sensors", methods=["GET"]) def get_sensor_data(): return jsonify(latest_sensor_data) # ğŸ“¤ Send control command to device @app.route("/control", methods=["POST"]) def send_control(): data = request.json command = data.get("command") if not command: return {"error": "Command is required"}, 400 mqtt_client.publish( Config.MQTT_TOPIC_CONTROL, json.dumps({"command": command}) ) return {"status": "Command sent", "command": command} if __name__ == "__main__": app.run(port=5000, debug=True) ğŸ¤– 5. IoT Device Simulator

This acts like a real device sending temperature and listening for commands.

device_simulator.pyimport paho.mqtt.client as mqtt import json import random import time from config import Config def on_connect(client, userdata, flags, rc): print("ğŸ“¡ Device connected to broker") client.subscribe(Config.MQTT_TOPIC_CONTROL) def on_message(client, userdata, msg): payload = json.loads(msg.payload.decode()) print("ğŸ›ï¸ Control Command Received:", payload) client = mqtt.Client() client.on_connect = on_connect client.on_message = on_message client.connect(Config.MQTT_BROKER, Config.MQTT_PORT, 60) client.loop_start() while True: sensor_data = { "temperature": random.randint(20, 35), "humidity": random.randint(40, 70) } client.publish(Config.MQTT_TOPIC_SENSOR, json.dumps(sensor_data)) print("ğŸ“¤ Sensor Data Sent:", sensor_data) time.sleep(5) â–¶ï¸ 6. Run the POCStep 1 â€” Start Flask Serverpython app.py 

You should see:

Connected to MQTT Broker Step 2 â€” Start Device Simulator (new terminal)python device_simulator.py 

Youâ€™ll see sensor data being sent every 5 seconds.

ğŸ§ª 7. Test the POCğŸ”¹ View sensor data received by Flask

Open browser or curl:

http://localhost:5000/sensors 

Youâ€™ll see JSON like:

[ { "topic": "poc/device/sensor", "payload": {"temperature": 28, "humidity": 55}, "timestamp": "2026-02-05T07:10:22" } ] ğŸ”¹ Send control command to devicecurl -X POST http://localhost:5000/control \ -H "Content-Type: application/json" \ -d '{"command":"TURN_ON_FAN"}' 

Device terminal will show:

ğŸ›ï¸ Control Command Received: {'command': 'TURN_ON_FAN'} ğŸ¯ What This POC ProvesFeatureDemonstratedMQTT PublishDevice â†’ FlaskMQTT SubscribeFlask receives sensor dataREST â†’ MQTTAPI sends commands to deviceBi-directional CommunicationYesReal-time IoT behaviorYesğŸš€ Next-Level Upgrades (Real Project Ready)

â€¢ Store sensor data in PostgreSQL
â€¢ Add user authentication
â€¢ Add WebSocket for live dashboard
â€¢ Dockerize Flask + MQTT broker
â€¢ Add TLS security

If you want, next I can give you Docker-based POC where Flask + Mosquitto broker run together ğŸ³




